import { useEffect, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import logo from "../../../assets/picture/Direct_Energy_logo.svg.png";
import qrpayment from "../../../assets/PromptPay-logo.png";
import { Divider, Button, message } from "antd";
import { getUserByID, UpdateCoin } from "../../../services";
import { UsersInterface } from "../../../interface/IUser";

const Index = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { chargers } = location.state || { chargers: [] };
  const [paymentMethod, setPaymentMethod] = useState<"qr" | "card">("qr");
  const [user, setUser] = useState<UsersInterface | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);

  const totalAmount = chargers.reduce(
    (sum: number, item: any) => sum + item.total,
    0
  );

  useEffect(() => {
    const userID = Number(localStorage.getItem("userid"));
    if (userID) {
      getUserByID(userID).then((res) => {
        if (res) setUser(res);
      });
    }
  }, []);

  const handlePayment = async () => {
    if (!user) return;

    if (paymentMethod === "qr") {
      navigate("/user/payment-by-qrcode", {
        state: { totalAmount: totalAmount.toFixed(2), userID: user.ID },
      });
    } else {
      if (user.Coin! < totalAmount) {
        message.error("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Coin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏° Coin ‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }

      setIsProcessing(true);
      const updatedCoin = user.Coin! - totalAmount;

      if (!user?.ID) {
        message.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Coin ‡πÑ‡∏î‡πâ: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
        setIsProcessing(false);
        return;
      }

      const result = await UpdateCoin({ user_id: user.ID, coin: updatedCoin });
      if (result) {
        message.success("‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Coin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
        setTimeout(() => {
          setIsProcessing(false);
          navigate("/user/charging");
        }, 2500);
      } else {
        message.error("‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å Coin ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        setIsProcessing(false);
      }
    }
  };

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6 text-gray-800">
      <img src={logo} style={{ width: "150px" }} />

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ */}
        <div className="space-y-4">
          <h1 className="text-2xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>

          <div className="border rounded-lg p-4 space-y-4">
            <div className="flex justify-between items-center">
              <div>
                <span className="bg-purple-100 text-orange-700 text-sm font-medium px-2 py-1 rounded">
                  ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
                </span>
                <p className="mt-1 text-sm">
                  {user?.FirstName} {user?.LastName} - {user?.Email}
                </p>
              </div>
              <button className="text-orange-600 hover:underline text-sm">
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>

          <div>
            <h2 className="text-lg font-semibold mt-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
            <div className="border rounded-lg p-4 space-y-4">
              {chargers.map((item: any, index: number) => (
                <div key={index}>
                  <div className="flex justify-between items-center gap-4">
                    <img
                      src={`http://localhost:8000/${item.picture}`}
                      alt={item.name}
                      className="w-16 h-16 object-cover rounded"
                    />
                    <div className="flex-1">
                      <h3 className="font-medium text-sm">{item.name}</h3>
                      <p className="text-xs text-gray-600">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏ü: {item.power}
                      </p>
                    </div>
                    <span className="text-orange-700 font-bold">
                      ‡∏ø{item.total.toFixed(2)}
                    </span>
                  </div>
                  {index < chargers.length - 1 && <Divider className="!my-2" />}
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* ‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô */}
        <div className="space-y-5">
          <h2 className="text-lg font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h2>
          <div className="border rounded-lg p-4 space-y-4">
            <div className="flex justify-between text-lg font-bold text-orange-700">
              <span>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
              <span>‡∏ø{totalAmount.toFixed(2)}</span>
            </div>
          </div>

          <div className="border rounded-lg p-4 space-y-6">
            <h3 className="font-semibold text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>

            <div className="flex items-center gap-2">
              <input
                type="radio"
                name="payment"
                checked={paymentMethod === "qr"}
                onChange={() => setPaymentMethod("qr")}
              />
              <span className="text-sm">QR Payment</span>
              <img src={qrpayment} className="h-9" alt="PromptPay" />
            </div>

            <div className="flex items-center gap-2">
              <input
                type="radio"
                name="payment"
                checked={paymentMethod === "card"}
                onChange={() => setPaymentMethod("card")}
              />
              <span className="text-sm">Coin</span>
              {user && (
                <span className="text-xs text-yellow-700 font-semibold bg-yellow-100 border border-yellow-400 px-2 py-0.5 rounded-full">
                  ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ {user.Coin!.toFixed(2)} Coin
                </span>
              )}
            </div>

            {/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏ì‡∏µ Coin ‡πÑ‡∏°‡πà‡∏û‡∏≠ */}
            {paymentMethod === "card" && user && user.Coin! < totalAmount && (
              <div className="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg shadow-sm">
                <p className="text-sm font-medium flex items-center gap-2">
                  ‚ö†Ô∏è <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Coin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏° Coin ‡∏Å‡πà‡∏≠‡∏ô</span>
                </p>
                <div className="mt-2">
                  <Button
                    type="link"
                    onClick={() => navigate("/user/my-coins")}
                    className="text-blue-600 px-0 font-semibold"
                  >
                    üëâ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏¥‡∏° Coin
                  </Button>
                </div>
              </div>
            )}

            <p className="text-xs text-gray-600 mt-2">
              ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ô{" "}
              <span className="underline">‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span> ‡πÅ‡∏•‡∏∞{" "}
              <span className="underline">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            </p>
          </div>

          <button
            onClick={handlePayment}
            disabled={isProcessing}
            className="w-full bg-orange-700 text-white py-2 rounded text-lg mt-2 hover:bg-orange-800 transition disabled:opacity-50"
          >
            {isProcessing ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•..." : "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô"}
          </button>
        </div>
      </div>
    </div>
  );
};

export default Index;
